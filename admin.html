<script>
    // –ü—Ä–æ—Å—Ç–æ–π –±—ç–∫–µ–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞
    const BACKEND_URL = 'https://fncvwotggxekubbasrjx.supabase.co/functions/v1/telegram-mini-app';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à ID –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    const user = tg.initDataUnsafe.user;
    const isAdmin = user && user.id === 7156971224;
    
    if (isAdmin) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        document.getElementById('admin-content').style.display = 'block';
        document.getElementById('access-denied').style.display = 'none';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        loadAdminData();
    } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–∫–∞–∑
        document.getElementById('admin-content').style.display = 'none';
        document.getElementById('access-denied').style.display = 'block';
        
        if (user) {
            document.getElementById('user-id-display').textContent = user.id;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    async function loadAdminData() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const statsResponse = await fetch(BACKEND_URL + '/admin/stats');
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                document.getElementById('total-users').textContent = stats.stats.totalUsers || '0';
                document.getElementById('total-balance').textContent = 
                    new Intl.NumberFormat('ru-RU').format(stats.stats.totalBalance || 0) + ' ‚ÇΩ';
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const settingsResponse = await fetch(BACKEND_URL + '/admin/settings');
            if (settingsResponse.ok) {
                const settings = await settingsResponse.json();
                if (settings.settings) {
                    document.getElementById('ref-percent-1').value = settings.settings.ref_percent_1 || 10;
                    document.getElementById('ref-percent-2').value = settings.settings.ref_percent_2 || 5;
                }
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
            document.getElementById('recent-actions').innerHTML = '<p style="text-align:center;color:#666;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>';
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    async function updateBalance() {
        const userId = document.getElementById('user-id').value;
        const amount = document.getElementById('amount').value;
        const reason = document.getElementById('reason').value;
        
        if (!userId || !amount) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID –∏ —Å—É–º–º—É');
            return;
        }
        
        const button = document.getElementById('update-btn');
        button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
        button.disabled = true;
        
        try {
            const response = await fetch(BACKEND_URL + '/admin/balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    adminId: 7156971224,
                    userId: userId,
                    amount: parseInt(amount),
                    reason: reason || '–ò–∑–º–µ–Ω–µ–Ω–∏–µ'
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                alert('‚úÖ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + result.user.balance + ' ‚ÇΩ');
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('user-id').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('reason').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                loadAdminData();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        } finally {
            button.innerHTML = 'üí∞ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å';
            button.disabled = false;
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    async function savePercentages() {
        const percent1 = document.getElementById('ref-percent-1').value;
        const percent2 = document.getElementById('ref-percent-2').value;
        
        const button = document.querySelector('.btn-success');
        button.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        button.disabled = true;
        
        try {
            const response = await fetch(BACKEND_URL + '/admin/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    adminId: 7156971224,
                    ref_percent_1: percent1,
                    ref_percent_2: percent2
                })
            });
            
            if (response.ok) {
                alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
            
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        } finally {
            button.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
            button.disabled = false;
        }
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.updateBalance = updateBalance;
    window.savePercentages = savePercentages;
</script>
